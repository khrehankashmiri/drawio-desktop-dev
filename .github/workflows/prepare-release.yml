name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 29.0.4)'
        required: true
        type: string
      previous_version:
        description: 'Previous version for changelog (e.g., 29.0.3). Leave empty to auto-detect.'
        required: false
        type: string
      drawio_ref:
        description: 'draw.io ref to use (tag, branch, or commit). Leave empty to use v{version}'
        required: false
        type: string
      dry_run:
        description: 'Dry run - validate only, do not commit'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '24'

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Validate version format
        run: |
          if ! [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Version must be in format X.Y.Z (e.g., 29.0.4)"
            exit 1
          fi
          echo "VERSION=${{ inputs.version }}" >> $GITHUB_ENV
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          check-latest: true
          
      - name: Log versions
        run: |
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          
      - name: Determine drawio ref
        run: |
          if [ -n "${{ inputs.drawio_ref }}" ]; then
            echo "DRAWIO_REF=${{ inputs.drawio_ref }}" >> $GITHUB_ENV
          else
            echo "DRAWIO_REF=v${{ inputs.version }}" >> $GITHUB_ENV
          fi
          
      - name: Update drawio submodule
        run: |
          cd drawio
          git fetch origin --tags
          
          # Check if ref exists
          if ! git rev-parse --verify "${{ env.DRAWIO_REF }}" >/dev/null 2>&1; then
            echo "::error::Ref '${{ env.DRAWIO_REF }}' not found in drawio repository"
            exit 1
          fi
          
          git checkout "${{ env.DRAWIO_REF }}"
          
          # Update any nested submodules in drawio
          git submodule update --init --recursive
          
          echo "DRAWIO_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "Updated drawio to: $(git describe --tags --always)"
          cd ..
          
      - name: Update package.json version
        run: |
          # Update version in package.json
          jq '.version = "${{ env.VERSION }}"' package.json > package.json.tmp
          mv package.json.tmp package.json
          
          echo "Updated package.json to version ${{ env.VERSION }}"
          grep '"version"' package.json
          
      - name: Install dependencies
        run: |
          # Use npm install (not ci) to update package-lock.json with latest versions within semver ranges
          npm install

      - name: Generate release notes
        run: |
          VERSION="${{ env.VERSION }}"
          PREV_VERSION="${{ inputs.previous_version }}"
          
          # Auto-detect previous version if not provided
          if [ -z "$PREV_VERSION" ]; then
            PREV_VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "")
          fi
          
          # Get electron version from package-lock.json (actual installed version)
          ELECTRON_VERSION=$(jq -r '.packages["node_modules/electron"].version' package-lock.json)
          echo "ELECTRON_VERSION=$ELECTRON_VERSION" >> $GITHUB_ENV
          
          # Generate release notes
          cat > release-notes.md << 'RELEASE_EOF'
          ## Release Notes for VERSION_PLACEHOLDER
          
          [Windows Installer](https://github.com/jgraph/drawio-desktop/releases/download/vVERSION_PLACEHOLDER/draw.io-VERSION_PLACEHOLDER-windows-installer.exe)
          [Windows No Installer (zip)](https://github.com/jgraph/drawio-desktop/releases/download/vVERSION_PLACEHOLDER/draw.io-VERSION_PLACEHOLDER-windows.zip)
          [macOS - Universal](https://github.com/jgraph/drawio-desktop/releases/download/vVERSION_PLACEHOLDER/draw.io-universal-VERSION_PLACEHOLDER.dmg)
          Linux - [deb](https://github.com/jgraph/drawio-desktop/releases/download/vVERSION_PLACEHOLDER/drawio-amd64-VERSION_PLACEHOLDER.deb), [AppImage](https://github.com/jgraph/drawio-desktop/releases/download/vVERSION_PLACEHOLDER/drawio-x86_64-VERSION_PLACEHOLDER.AppImage) or [rpm](https://github.com/jgraph/drawio-desktop/releases/download/vVERSION_PLACEHOLDER/drawio-x86_64-VERSION_PLACEHOLDER.rpm)
          Windows intel x32 releases are marked -ia32-
          
          **ChangeLog:**
          - Uses electron ELECTRON_PLACEHOLDER.
          - Updates to [draw.io core VERSION_PLACEHOLDER](https://github.com/jgraph/drawio/blob/vVERSION_PLACEHOLDER/ChangeLog).PREV_PLACEHOLDER
          RELEASE_EOF
          
          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" release-notes.md
          sed -i "s/ELECTRON_PLACEHOLDER/${ELECTRON_VERSION}/g" release-notes.md
          if [ -n "$PREV_VERSION" ]; then
            sed -i "s/PREV_PLACEHOLDER/ All changes from ${PREV_VERSION} to ${VERSION} are added in this build./g" release-notes.md
          else
            sed -i "s/PREV_PLACEHOLDER//g" release-notes.md
          fi
          
          echo "## Generated Release Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat release-notes.md >> $GITHUB_STEP_SUMMARY
          
          echo "Release notes generated with Electron version: $ELECTRON_VERSION"
        
      - name: Security audit
        id: audit
        continue-on-error: true
        run: |
          echo "## npm audit results" >> $GITHUB_STEP_SUMMARY
          
          # Run audit and capture output
          npm audit --json > audit-results.json 2>&1 || true
          
          # Parse results
          CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
          HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
          MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' audit-results.json)
          LOW=$(jq '.metadata.vulnerabilities.low // 0' audit-results.json)
          
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY
          
          # Save for artifact
          npm audit > audit-report.txt 2>&1 || true
          
          # Fail if critical or high vulnerabilities
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::error::Security vulnerabilities found: $CRITICAL critical, $HIGH high"
            echo "AUDIT_FAILED=true" >> $GITHUB_ENV
          else
            echo "AUDIT_FAILED=false" >> $GITHUB_ENV
          fi
          
      - name: Check outdated dependencies
        run: |
          echo "## Outdated dependencies" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm outdated >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          npm outdated > outdated-report.txt 2>&1 || true
          
      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-evidence-v${{ env.VERSION }}
          path: |
            audit-results.json
            audit-report.txt
            outdated-report.txt
            release-notes.md
          retention-days: 365
          
      - name: Fail if audit has issues
        if: env.AUDIT_FAILED == 'true'
        run: |
          echo "::error::Cannot proceed with release due to security vulnerabilities"
          echo "Review audit-report.txt and fix vulnerabilities before releasing"
          exit 1
          
      - name: Generate release summary
        run: |
          echo "## Release Preparation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ env.VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Electron | ${{ env.ELECTRON_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| drawio ref | ${{ env.DRAWIO_REF }} |" >> $GITHUB_STEP_SUMMARY
          echo "| drawio commit | ${{ env.DRAWIO_COMMIT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js | $(node --version) |" >> $GITHUB_STEP_SUMMARY
          echo "| npm | $(npm --version) |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry run | ${{ inputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY
          
      - name: Commit changes
        if: inputs.dry_run == false
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Save release notes content before cleanup
          cp release-notes.md /tmp/release-notes.md
          
          # Create release branch
          git checkout -b "releases/v${{ env.VERSION }}"
          
          # Remove generated files that shouldn't be committed
          # (package-lock.json IS committed to lock electron version)
          rm -f audit-results.json audit-report.txt outdated-report.txt release-notes.md
          
          git add -A
          git commit -m "Prepare release v${{ env.VERSION }}

          - Updated drawio submodule to ${{ env.DRAWIO_REF }} (${{ env.DRAWIO_COMMIT }})
          - Updated package.json version to ${{ env.VERSION }}
          - Updated package-lock.json
          - Electron version: ${{ env.ELECTRON_VERSION }}
          
          Automated by prepare-release workflow"
          
          git push origin "releases/v${{ env.VERSION }}"
          
          # Restore release notes for PR creation
          cp /tmp/release-notes.md release-notes.md
          
      - name: Create Pull Request
        if: inputs.dry_run == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the release notes content
          RELEASE_NOTES=$(cat release-notes.md)
          
          # Create PR
          PR_URL=$(gh pr create \
            --base dev \
            --head "releases/v${{ env.VERSION }}" \
            --title "Release v${{ env.VERSION }}" \
            --body "## Release Preparation

          This PR prepares release v${{ env.VERSION }}.

          ### Changes
          - Updated drawio submodule to ${{ env.DRAWIO_REF }}
          - Updated package.json version to ${{ env.VERSION }}
          - Electron version: ${{ env.ELECTRON_VERSION }}

          ### Audit Results
          - npm audit: âœ… No critical/high vulnerabilities

          ### After Merging
          Create and push the tag to trigger builds:
          \`\`\`bash
          git checkout dev
          git pull
          git tag -a v${{ env.VERSION }} -m \"Release v${{ env.VERSION }}\"
          git push origin v${{ env.VERSION }}
          \`\`\`

          ---

          ${RELEASE_NOTES}
          ")
          
          echo "## Pull Request Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PR: ${PR_URL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review and merge the PR" >> $GITHUB_STEP_SUMMARY
          echo "2. Create the tag: \`git tag -a v${{ env.VERSION }} -m \"Release v${{ env.VERSION }}\"\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Push the tag: \`git push origin v${{ env.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
          
      - name: Summary
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "::notice::Dry run complete. No changes committed."
          else
            echo "::notice::Release PR created for v${{ env.VERSION }}. Review, merge, then create tag to trigger builds."
          fi